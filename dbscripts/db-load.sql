
--CREATE TABLE multimedia AS SELECT * FROM read_csv_auto('dbs/multimedia-numberedvd.txt', SEP='\t', header=True, normalize_names=True, quote='|', sample_size=300000);

--CREATE TABLE occurrence AS SELECT * FROM read_csv_auto('dbs/occurrence.txt', SEP='\t', header=True, normalize_names=True, quote='}', sample_size=3000000);

CREATE OR REPLACE VIEW images AS 
SELECT m._type, m.format, m.identifier, m.imgid, o.* 
FROM multimedia m 
JOIN occurrence o ON o.gbifid = m.gbifid 
JOIN converted c ON c.gbifid = m.gbifid AND c.imgid = m.imgid;
   
CREATE OR REPLACE VIEW validimages AS
SELECT *
FROM images
WHERE decimallatitude BETWEEN 49.8 AND 60.9
AND decimallongitude BETWEEN -10.9 AND 1.8;

CREATE OR REPLACE VIEW validobservations AS
SELECT * 
FROM occurrence
WHERE decimallatitude BETWEEN 49.8 AND 60.9
AND decimallongitude BETWEEN -10.9 AND 1.8;

CREATE OR REPLACE TABLE ignoredimages (gbifid BIGINT, reason VARCHAR); 
INSERT INTO ignoredimages (gbifid, reason) SELECT gbifid, 'sheet cards' FROM occurrence o WHERE o.institutioncode IN();


CREATE OR REPLACE VIEW rankedimages AS 
SELECT r.*, 
	ROW_NUMBER() OVER (PARTITION BY r.familykey, r.genuskey, r.specieskey ORDER BY r.score, r.gbifid DESC) as rank
FROM (
	SELECT o.gbifid, m.imgid, o."_family", o.genus, o.species, o.familykey, o.genuskey, o.specieskey,
		 COALESCE(vo.score, 1) + COALESCE(c.score, 3) + m.imgid * 2 AS score,
	FROM occurrence o 
	JOIN (
		SELECT COUNT(*) AS scount, o.familykey, o.genuskey, o.specieskey, o."_family" , o.genus, o.species
		FROM validobservations o
		GROUP BY 2,3,4,5,6,7
	) vs ON vs.familykey = o.familykey AND o.genuskey = vs.genuskey AND o.specieskey = vs.specieskey 
	LEFT JOIN (
		SELECT 0 AS score, gbifid FROM validobservations
	) vo ON vo.gbifid = o.gbifid
	JOIN multimedia m ON m.gbifid = o.gbifid
	-- Preference images already downloaded
	LEFT JOIN (
		SELECT 0 AS score, gbifid, imgid FROM converted
	) c ON m.imgid = c.imgid AND m.gbifid = c.gbifid
	--Remove imgs with errors
	LEFT JOIN errors e ON m.imgid = e.imgid AND m.gbifid = e.gbifid
	WHERE e.gbifid IS NULL
) r;


CREATE OR REPLACE VIEW trainingimages AS 
SELECT r.gbifid, r.imgid, r."_family", r.genus, r.species, r.familykey, r.genuskey, r.specieskey, r.rank
FROM rankedimages r 
JOIN (
	SELECT COUNT(*), o.familykey, o.genuskey, o.specieskey
	FROM rankedimages o 
	GROUP BY 2,3,4
	HAVING COUNT(*) > 100
) s ON r.familykey = s.familykey AND r.genuskey = s.genuskey AND r.specieskey = s.specieskey
WHERE r.rank < 1000
ORDER BY r.rank;


SELECT COUNT(*), SUM(CASE WHEN c.gbifid IS NULL THEN 1 ELSE 0 END)
FROM trainingimages t 
LEFT JOIN converted c ON t.gbifid = c.gbifid AND t.imgid = c.imgid 

SELECT t.gbifid || '-' || t.imgid || '.png'
FROM trainingimages t 
JOIN converted c ON t.gbifid = c.gbifid AND t.imgid = c.imgid 



SELECT v.decimallatitude, v.decimallongitude, COUNT(*) 
from validobservations v   
GROUP BY 1,2 
HAVING COUNT(*) > 1000

ORDER BY COUNT(*) DESC

SELECT * FROM main.validobservations WHERE decimallatitude = 52.689987 AND decimallongitude = 1.179842

SELECT * FROM occurrence  LIMIT 100;


SELECT * FROM multimedia  WHERE gbifid IN (1432922485,1433350180,1433919107,1450421402,1671149608,1824043730,1951461581,1951609160,1954512441,1957078887,1959474262,1968415288,1968477436,1968779078,1972032547,1977462470,1977613276,1995206588,2237943594,2237954951,2238160484,2238180129,2238210685,2238360693,2238403701,2238408448,2238466488,2238470375,2238483430,2238484733,2238509041,2238518671,2238536141,2238537999,2238545796,2238551896,2238554495,2238563693,2238566113,2238569664,2238572035,2238573125,2238579303,2238583681,2242671835,2269224443,2270876813,2271102716,2273187744,2283065820,2294394868,2332425469,2382320214,2397478143,2404797825,2406484610,2424121863,2425493158,2427872640,2446758431,2446759255,2447987546,2449441758,2460546890,2556497481,2563095820,2563096703,2563490590,2571560624,2572465178,2576353705,2597935063,2609286501,2634450756,2815498334,2818708549,2823042368,2826246846,2831555413,2832220340,2832362281,2832424594,2833436446,2833499663,2834521570,2840500529,2844722236,2845581639,2847882838,2865981924,2883260314,2898291130,2900108370,2901325313,2901933351,2901936324,2901939321,2963794559,2980808630,2984630306,2986446306,2986446353,2988465798,2993888660,2994389304,2994390305,3014634364,3017952863,3018100893,3044900899,3049303096,3061392431,3061601480,3068171303,3078379693,3079568954,3079724660,3079796120,3079798696,3080245336,3124855475,3126946334,3303195368,3320916939,3325689515,3325899328,3327884390,3328010438,3330474374,3330743674,3333190534,3334602355,3338485469,3353162400,3355063999,3355087955,3355460739,3355972333,3358347350,3384381215,3392603339,3412517404,3415370900,3415408239,3415680499,3417631319,3417634350,3417645334,3424507330,3430350170,3441151594,3441209404,3455274829,3455411744,3455875019,3455881033,3455894358,3460223330,3463106320,3465680303,3466009168,3466009168,3466010655,3466240680,3468810440,3704373320,3704375305,3716358979,3716978538,3717766963,3718150285,3718629633,3718977448,3718977448,3719782965,3722596193,3722975088,3723106265,3723315334,3723467663,3724566073,3724885183,3725789863,3727665088,3728416363,3730839449,3731534829,3731706313,3732945263,3733237783,3743083390,875249655)


SELECT COUNT(*), o.institutioncode, o.institutioncode, o.ownerinstitutioncode
FROM multimedia m
JOIN occurrence o ON o.gbifid = m.gbifid 
WHERE o.gbifid IN (1144810258,1144812193,1144820045,1144825037,1144831332,1144842263,1144846233,1144854005,1144857407,1269588557,1269588850,1269588902,1269589063,1269589185,1269589952,1269591237,1269591475,1269591752,1269591973,1269592288,1269592737,1269592983,1269593128,1269593203,1269593340,1269593517,1269593831,1269595021,1269595501,1269595558,1269596051,1269596325,1269596352,1269597082,1269597131,1269597426,1269597432,1269598156,1269598245,1269598376,1269599008,1269599816,1269600925,1269601297,1269601870,1269602091,1269602408,1269602753,1269603021,1269603152,1269603225,1269604116,1269604128,1269604297,1269605123,1269605136,1269605357,1269606576,1269606748,1269606786,1269607072,1269607117,1269607308,1269607593,1269608367,1269608981,1269609071,1269609271,1269609525,1269609765,1269609925,1269609935,1269610512,1269610541,1269611148,1269611463,1269612756,1269612908,1269613163,1269613170,1269613505,1269613650,1269616846,1269617213,1269618637,1302810402,1302812095,1302812911,1302813670,1302815242,1302816762,1302817806,1302818582,1302819126,1302819501,1302820196,1302820421,1302824233,1302824466,1302826220,1302826755,1302828005,1302828326,1302829186,1302829676,1302829943,1431199211,1503047151,1503068341,1503068733,1503069007,1503069020,1503069266,1503069317,1503070198,1503070476,1503070576,1503070602,1503071430,1503072017,1503072018,1503072142,1503072338,1503072486,1503072705,1503072728,1503072731,1503072991,1503073010,1503073022,1503073088,1503073285,1503073351,1503073450,1503073548,1503073577,1503073770,1503074326,1503074375,1503074407,1503074855,1503075137,1503075227,1503077683,1503077796,1503077863,1503078123,1503078210,1503078391,1503078740,1503078891,1503079006,1503079047,1503079552,1503079787,1503079922,1503080111,1503081032,1503081081,1503081207,1503081326,1503081380,1503081656,1503081990,1503082151,1503082160,1503082178,1503082208,1503082473,1503082986,1503083588,1503083720,1503083951,1503084331,1503084447,1503084743,1503086110,1838425262,1838427953,1838428305,1838428593,1838428731,1838428818,1838429078,1851022750,1851023083,1851023235,1851023627,1851023721,1851023736,1851025342,1851025561,1851026502,1851026645,1851026768,1851026946,1851027011,1851027580,1851027710,1851028091,1851028091,1851028602,1851029060,1851029668,1851029796,1851030377,1851030422,1851030642,1928289771,1929023230,1930420418,1930607718,1931072242,1989381913,2005088013,2005088260,2005089073,2005089395,2005089450,2005090520,2005091210,2005091442,2005091552,2005092367,2005092418,2005093382,2005094338,2005094433,2005094440,2005095251,2013954995,2013963650,2013964940,2028337527,2028337527,2028337527,2028337527,2028342742,2028354505,2028366338,2028366338,2028390172,2028390178,2238065501,2238195176,2266320303,2268237924,2268238641,2268238769,2268239055,2268239135,2268239164,2268239436,2268239545,2268239623,2268239680,2268239700,2268239748,2268240100,2268240180,2268240248,2268240369,2268240373,2268240519,2268240931,2268241260,2268242158,2268242718,2268243443,2268243896,2268244055,2268244893,2268245076,2268246129,2268246144,2268246225,2268250194,2268253741,2268266239,2268266474,2268266713,2268294535,2269341311,2269344393,2269359018,2270734315,2436859703,2573263645,2573265491,2573265724,2573265766,2640614678,2640619766,2640628560,2640629310,3110124605,3110124769,3110125173,3110125796,3110126184,3110126434,3110127044,3110127739,3110127900,3110129900,3110130494,3110130906,3110133429,3110133488,3110134693,3110134778,3110135993,3110137144,3110139121,3110139250,3110139471,3110139650,3110142388,3110142998,3110144276,3110144634,3110144695,3110145023,3110145911,3110146830,3110148165,3110148889,3110150223,3110150766,3110150973,3110151066,3110151593,3110153430,3110153551,3110154666,3110155020,3110157271,3110158606,3110159660,3110160495,3110162306,3356733693,3356734040,3356734084,3356734263,3356734560,3356734633,3356734835,3356735024,3356736078,3356736455,3356736919,3356737924,3356738065,3356738415,3356738928,3356739415,3356739463,3356739900,3356739989,3356740044,3356740064,3384841095,3461417698,3461423495,3696062268,3696084598,3752923349,3752924018,3752924465,852893036,855630920,855685511)
GROUP BY 2,3,4
ORDER BY 1 DESC



